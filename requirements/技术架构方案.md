# 知治口腔服务平台 - 技术架构方案

## 1. 整体架构设计

### 1.1 系统架构图
```
+-------------------+     +-------------------+     +-------------------+
|   微信小程序       |     |   企业官网         |     |   后台管理系统     |
|   (前端)          |     |   (Next.js)       |     |   (React Admin)   |
+-------------------+     +-------------------+     +-------------------+
        |                         |                         |
        |                         |                         |
        +------------+------------+------------+------------+
                     |                         |
             +-------------------+     +-------------------+
             |   API Gateway     |     |   Admin API       |
             |   (Node.js)       |     |   (Node.js)       |
             +-------------------+     +-------------------+
                     |                         |
                     +------------+------------+
                                  |
                         +-------------------+
                         |   业务服务层       |
                         |   (Node.js)       |
                         +-------------------+
                                  |
                         +-------------------+
                         |   数据访问层       |
                         |   (ORM)          |
                         +-------------------+
                                  |
                         +-------------------+
                         |   数据库层         |
                         |   (MySQL)        |
                         +-------------------+
```

## 2. 技术栈选择

### 2.1 前端技术栈

#### 企业官网 (Next.js + React)
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript
- **样式**: Tailwind CSS + CSS Modules
- **UI组件**: Ant Design / MUI
- **状态管理**: Zustand / React Context
- **路由**: Next.js App Router
- **构建工具**: Vite / Webpack

#### 微信小程序
- **框架**: 微信小程序原生框架
- **语言**: JavaScript + WXML + WXSS
- **组件化**: Component组件开发
- **网络请求**: 封装wx.request
- **状态管理**: 小程序自带data系统

#### 后台管理系统
- **框架**: React 18
- **语言**: TypeScript
- **UI组件**: Ant Design Pro
- **状态管理**: Redux Toolkit
- **路由**: React Router v6

### 2.2 后端技术栈

#### 核心框架
- **运行时**: Node.js 18+
- **框架**: Express.js 4.x
- **语言**: TypeScript
- **API文档**: Swagger/OpenAPI

#### 数据库相关
- **ORM**: Prisma / TypeORM
- **数据库**: PostgreSQL 15+
- **缓存**: Redis
- **连接池**: pg

#### 安全认证
- **认证**: JWT (JSON Web Token)
- **密码加密**: bcrypt
- **请求验证**: Zod / Joi
- **CORS**: 跨域配置

### 2.3 基础设施

#### 部署环境
- **服务器**: 阿里云ECS / AWS EC2
- **容器化**: Docker + Docker Compose
- **编排**: Kubernetes (可选)

#### 存储服务
- **对象存储**: 阿里云OSS / AWS S3
- **CDN**: 阿里云CDN / Cloudflare
- **数据库**: 阿里云RDS PostgreSQL / AWS RDS PostgreSQL

#### 监控日志
- **应用监控**: PM2 / Kubernetes
- **日志收集**: ELK Stack / Loki
- **错误追踪**: Sentry
- **性能监控**: New Relic / Datadog

## 3. 项目结构规划

### 3.1 Monorepo结构
```
zhizhi-health/
├── packages/
│   ├── web-app/          # 企业官网 (Next.js)
│   ├── mini-program/     # 微信小程序
│   ├── admin-panel/      # 后台管理系统
│   ├── api-server/       # 主API服务
│   ├── shared/           # 共享代码库
│   └── types/            # 共享TypeScript类型定义
├── infrastructure/       # 基础设施配置
├── scripts/             # 部署脚本
└── docs/               # 项目文档
```

### 3.2 API服务结构
```
api-server/
├── src/
│   ├── controllers/     # 控制器层
│   ├── services/        # 服务层
│   ├── models/          # 数据模型
│   ├── middleware/      # 中间件
│   ├── utils/           # 工具函数
│   ├── types/           # TypeScript类型
│   ├── config/          # 配置文件
│   └── index.ts         # 入口文件
├── prisma/              # Prisma schema和迁移
├── tests/               # 测试文件
└── package.json
```

## 4. 数据库设计详情

### 4.1 核心表结构

#### users 用户表
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  openid VARCHAR(255) UNIQUE,
  unionid VARCHAR(255),
  nickname VARCHAR(100),
  avatar_url VARCHAR(500),
  phone VARCHAR(20),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### doctors 医生表
```sql
CREATE TABLE doctors (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  title VARCHAR(100),
  specialty VARCHAR(200),
  hospital VARCHAR(200),
  location VARCHAR(100),
  avatar_url VARCHAR(500),
  introduction TEXT,
  rating DECIMAL(3,2) DEFAULT 0.0,
  consultation_count INTEGER DEFAULT 0,
  is_available BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### appointments 预约表
```sql
CREATE TABLE appointments (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id),
  doctor_id INTEGER NOT NULL REFERENCES doctors(id),
  appointment_date DATE NOT NULL,
  appointment_time TIME NOT NULL,
  service_type VARCHAR(100),
  patient_name VARCHAR(100) NOT NULL,
  patient_phone VARCHAR(20) NOT NULL,
  patient_age INTEGER,
  patient_gender VARCHAR(10) CHECK (patient_gender IN ('male', 'female', 'other')),
  symptoms TEXT,
  notes TEXT,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'completed', 'cancelled')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 5. API设计规范

### 5.1 RESTful API设计

#### 响应格式
```typescript
interface ApiResponse<T> {
  code: number;
  message: string;
  data: T;
  timestamp: string;
}

// 成功响应
{
  "code": 200,
  "message": "Success",
  "data": { ... },
  "timestamp": "2025-01-20T10:30:00Z"
}

// 错误响应
{
  "code": 400,
  "message": "Invalid parameters",
  "data": null,
  "timestamp": "2025-01-20T10:30:00Z"
}
```

#### 错误码规范
- `200`: 成功
- `400`: 客户端错误
- `401`: 未授权
- `403`: 禁止访问
- `404`: 资源不存在
- `500`: 服务器错误

### 5.2 重要API端点

#### 认证相关
```http
POST /api/auth/wx-login    # 微信登录
GET /api/auth/profile      # 获取用户信息
PUT /api/auth/profile      # 更新用户信息
```

#### 医生相关
```http
GET /api/doctors           # 获取医生列表
GET /api/doctors/:id       # 获取医生详情
GET /api/doctors/:id/schedule  # 获取医生排班
```

#### 预约相关
```http
POST /api/appointments     # 创建预约
GET /api/appointments      # 获取我的预约
PUT /api/appointments/:id  # 更新预约
DELETE /api/appointments/:id # 取消预约
```

## 6. 安全设计

### 6.1 认证授权
- JWT token认证
- Token自动续期机制
- 接口权限控制
- 微信登录安全验证

### 6.2 数据安全
- SQL注入防护
- XSS攻击防护
- CSRF保护
- 数据加密传输(HTTPS)

### 6.3 敏感信息保护
- 手机号脱敏显示
- 身份证信息加密存储
- 日志敏感信息过滤

## 7. 性能优化策略

### 7.1 数据库优化
- 合理索引设计
- 查询性能优化
- 连接池配置
- 读写分离(可选)

### 7.2 缓存策略
- Redis缓存热点数据
- 数据库查询结果缓存
- 页面静态化
- CDN加速静态资源

### 7.3 前端优化
- 代码分割和懒加载
- 图片优化和懒加载
- 组件级缓存
- 请求合并和防抖

## 8. 部署方案

### 8.1 开发环境
- Docker Compose本地开发
- 热重载开发服务器
- 数据库本地实例

### 8.2 生产环境
- 阿里云Kubernetes集群
- 自动CI/CD流水线
- 蓝绿部署策略
- 自动扩缩容

### 8.3 监控告警
- 应用性能监控(APM)
- 错误日志收集
- 业务指标监控
- 短信通知状态监控

## 9. 开发规范

### 9.1 代码规范
- ESLint + Prettier代码格式化
- TypeScript严格模式
- Git提交规范
- 代码审查流程

### 9.2 测试规范
- 单元测试覆盖率要求
- 集成测试覆盖核心流程
- E2E测试关键用户路径
- 性能测试基准

## 10. 项目里程碑

### 10.1 第一阶段 (2周)
- [ ] 项目基础架构搭建
- [ ] 数据库设计和迁移
- [ ] 用户认证系统
- [ ] 医生管理API

### 10.2 第二阶段 (3周)
- [ ] 预约功能完整实现
- [ ] 短信通知集成
- [ ] 企业官网开发
- [ ] 后台管理系统

### 10.3 第三阶段 (2周)
- [ ] 微信小程序开发
- [ ] 测试和优化
- [ ] 部署上线
- [ ] 监控系统搭建

---

*技术架构版本: v1.0*
*最后更新: 2025-01-20*
*适用项目: 知治口腔服务平台*
*技术负责人: 开发团队*